{"version":3,"file":"admin.js","sources":["../src/common/index.ts","../src/admin/index.tsx"],"sourcesContent":["import app from 'flarum/common/app';\n\napp.initializers.add('wusong8899-email-common', () => {\n  console.log('[wusong8899/flarum-email] Hello, forum and admin!');\n});\n","import app from 'flarum/admin/app';\nimport Button from 'flarum/common/components/Button';\nimport LoadingIndicator from 'flarum/common/components/LoadingIndicator';\nimport { showAlert } from 'flarum/common/helpers/alert';\nimport Component from 'flarum/common/Component';\nimport m, { Vnode } from 'mithril';\n\nexport { default as extend } from './extend';\n\nclass EmailExportButton extends Component {\n  private loading = false;\n  private exportCount: number | null = null;\n  private lastExportDate: string | null = null;\n\n  oninit(vnode: Vnode) {\n    super.oninit(vnode);\n    // 从 localStorage 恢复上次导出信息\n    const lastExport = localStorage.getItem('wusong8899_email_last_export');\n    if (lastExport) {\n      try {\n        const data = JSON.parse(lastExport);\n        this.exportCount = data.count;\n        this.lastExportDate = data.date;\n      } catch (e) {\n        // 忽略解析错误\n      }\n    }\n  }\n\n  view(): Vnode {\n    return (\n      <div className=\"Form-group\">\n        <label>导出有效邮箱</label>\n        <p className=\"helpText\">\n          点击导出所有通过 RFC + DNS 检查的唯一邮箱，每行一个。\n          {this.exportCount !== null && this.lastExportDate && (\n            <span className=\"helpText-success\">\n              <br />上次导出: {this.exportCount} 个邮箱 ({this.formatDate(this.lastExportDate)})\n            </span>\n          )}\n        </p>\n        <Button\n          className=\"Button Button--primary\"\n          type=\"button\"\n          onclick={this.handleExport.bind(this)}\n          disabled={this.loading}\n          loading={this.loading}\n        >\n          {this.loading ? '导出中...' : '导出邮箱'}\n        </Button>\n      </div>\n    );\n  }\n\n  private async handleExport() {\n    if (this.loading) return;\n\n    this.loading = true;\n    m.redraw();\n\n    try {\n      const response = await app.request({\n        method: 'GET',\n        url: app.forum.attribute('apiUrl') + '/admin-email-export',\n        raw: true\n      });\n\n      // 创建 Blob 并下载\n      const blob = new Blob([response as string], { type: 'text/plain;charset=utf-8' });\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');\n      a.href = url;\n      a.download = `valid-emails-${date}.txt`;\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n      window.URL.revokeObjectURL(url);\n\n      // 计算导出的邮箱数量\n      const lines = (response as string).trim().split('\\n').filter((line: string) => line.trim());\n      this.exportCount = lines.length;\n      this.lastExportDate = new Date().toISOString();\n\n      // 保存到 localStorage\n      localStorage.setItem('wusong8899_email_last_export', JSON.stringify({\n        count: this.exportCount,\n        date: this.lastExportDate\n      }));\n\n      app.alerts.show(\n        { type: 'success' },\n        `成功导出 ${this.exportCount} 个有效邮箱！`\n      );\n    } catch (error) {\n      console.error('Export failed:', error);\n\n      let errorMessage = '导出失败，请稍后重试';\n      if ((error as any).status === 403) {\n        errorMessage = '权限不足，只有管理员可以导出邮箱';\n      } else if ((error as any).status === 500) {\n        errorMessage = '服务器错误，请检查 PHP Intl 扩展是否已安装';\n      } else if ((error as any).status === 204) {\n        errorMessage = '没有找到有效的邮箱地址';\n      }\n\n      app.alerts.show(\n        { type: 'error' },\n        errorMessage\n      );\n    } finally {\n      this.loading = false;\n      m.redraw();\n    }\n  }\n\n  private formatDate(isoString: string): string {\n    try {\n      const date = new Date(isoString);\n      const options: Intl.DateTimeFormatOptions = {\n        year: 'numeric',\n        month: '2-digit',\n        day: '2-digit',\n        hour: '2-digit',\n        minute: '2-digit'\n      };\n      return date.toLocaleString('zh-CN', options);\n    } catch (e: any) {\n      return isoString;\n    }\n  }\n}\n\napp.initializers.add('wusong8899-email', () => {\n  app.extensionData.for('wusong8899-email').registerSetting(function() {\n    return <EmailExportButton />;\n  });\n});\n"],"names":["app","EmailExportButton","Component","vnode","lastExport","data","m","Button","response","blob","url","a","date","lines","line","error","errorMessage","isoString","options"],"mappings":"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"}